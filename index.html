<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sorteador de Quest√µes </title>
<style>
/* ======== ESTILOS GLOBAIS ======== */
:root{
  --glass: rgba(255,255,255,0.12);
  --glass-dark: rgba(0,0,0,0.08);
  --radius: 12px;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin:0; padding:0;
  display:flex; flex-direction:column; align-items:center;
  min-height:100vh;
  transition: background 0.5s, color 0.5s;
}
/* temas */
body.dark { background: linear-gradient(135deg, #395a8f, #2e1f82, #291972); color:#fff; animation: bgGradient 12s ease infinite alternate; }
body.light { background: linear-gradient(135deg, #aad4ff, #7792ca, #486ea8); color:#111; }
@keyframes bgGradient { 0%{background-position:0% 50%;}100%{background-position:100% 50%;} }

header {
  text-align:center;
  padding:18px 22px;
  background:rgba(0,0,0,0.06);
  width:100%;
  display:flex; justify-content:space-between; align-items:center;
  backdrop-filter:blur(6px);
}
header h1 { margin:0; font-size:1.6rem; font-weight:700; }

/* Tema toggle */
.theme-toggle {
  font-size:1.1rem; background:none; border:none; cursor:pointer; transition: transform 0.25s;
}
.theme-toggle:hover { transform: rotate(18deg) scale(1.05); }

/* HAMBURGER / MENU */
.header-right {
  display:flex;
  gap:8px;
  align-items:center;
}
.hamburger {
  width:40px; height:40px; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg,#111827,#374151); color:#fff;
  border:none; cursor:pointer; font-weight:700; box-shadow:0 6px 14px rgba(0,0,0,0.22);
}
.hamburger:hover{ transform:scale(1.03); }
.menu {
  position:absolute;
  top:68px;
  right:22px;
  min-width:220px;
  background: rgba(0,0,0,0.72);
  color:#fff;
  padding:10px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.36);
  display:none;
  z-index:50;
}
.menu button {
  display:block;
  width:100%;
  text-align:left;
  margin:6px 0;
  background:transparent;
  color:inherit;
  padding:8px 10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
.menu button:hover{ background: rgba(255,255,255,0.06); }

/* indicador de modo (pequeno badge no header) */
.mode-badge {
  font-size:0.85rem;
  padding:6px 8px;
  border-radius:8px;
  background: rgba(255,255,255,0.08);
  color:inherit;
}

/* rest of previous styles... */
.container {
  display:flex;
  gap:18px;
  margin:18px 0 40px 0;
  width:92%;
  max-width:1200px;
  flex-wrap:wrap;
}

.card {
  background: var(--glass);
  border-radius:18px;
  padding:18px;
  box-shadow:0 8px 20px rgba(0,0,0,0.28);
  flex:1; min-width:300px;
  transition: transform 0.28s ease, background 0.5s;
}
body.light .card { background: var(--glass-dark); box-shadow:0 4px 12px rgba(0,0,0,0.12);} 
.card:hover { transform: translateY(-6px); }
.card h2 { text-align:center; margin-bottom:12px; font-size:1.25rem; border-bottom:2px solid rgba(255,255,255,0.12); padding-bottom:8px; }
body.light .card h2 { border-bottom:2px solid rgba(0,0,0,0.08); }

#question-box {
  font-size:1.05rem; text-align:center; min-height:100px; padding:14px;
  border-radius:12px; background: rgba(0,0,0,0.28); margin-top:12px;
  opacity:0; transform:translateY(10px); transition: all 0.45s ease;
}
body.light #question-box { background: rgba(255,255,255,0.04); }
#question-box.show { opacity:1; transform:translateY(0); }

/* ===== TIMER ===== */
#timer-display { font-size:2rem; text-align:center; margin:12px 0; font-weight:700; }
#timer-display.running { animation:pulse 1s infinite alternate; }
@keyframes pulse { 0%{transform:scale(1);}100%{transform:scale(1.03);} }
#timer-display.finished { animation: flash 0.5s alternate 6; color:#fff; }
@keyframes flash { from{opacity:1;} to{opacity:0.2;} }

/* HIST√ìRICO */
#history-list { max-height:140px; overflow-y:auto; padding-left:10px; list-style:none; margin:0; border:1px solid rgba(0,0,0,0.12); border-radius:10px; background: rgba(0,0,0,0.04); }
#history-list li { background: rgba(255,255,255,0.06); margin:8px; padding:8px 12px; border-radius:8px; font-size:0.95rem; }
body.light #history-list li { background: rgba(0,0,0,0.04); }

/* PARTICIPANTES */
#participants-list { list-style:none; padding-left:10px; max-height:300px; overflow-y:auto; margin-top:10px; }
#participants-list li { display:flex; justify-content:space-between; align-items:center; background: rgba(255,255,255,0.06); margin:8px 0; padding:8px 12px; border-radius:8px; font-size:0.95rem; }
body.light #participants-list li { background: rgba(0,0,0,0.04); }

input[type="text"], input[type="number"] { padding:6px; border-radius:6px; border:1px solid #ccc; }

/* ===== BOT√ïES ===== */

button {
  cursor: pointer;
  border: none;
  font-weight: 700;
  transition: all 0.22s ease;
  border-radius: 10px;
  padding: 8px 14px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.22);
  transform: translateY(0);
  outline: none;
}
button:active {
  transform: translateY(2px) scale(0.99);
  box-shadow: 0 3px 8px rgba(0,0,0,0.18);
}
button:focus{ box-shadow: 0 0 0 4px rgba(99,102,241,0.12); }

/* Bot√µes pequenos (filtros / reset) - tom AZUL */
.small-btn {
  font-size: 0.95rem;
  background: linear-gradient(135deg,#3b82f6,#1e40af);
  color: #fff;
}
.small-btn:hover { box-shadow: 0 0 16px #60a5fa; transform: translateY(-3px) scale(1.04); }

/* Bot√£o de destaque (sortear) - LARANJA/DOURADO */
.medium-btn {
  font-size: 1.15rem;
  padding: 12px 24px;
  background: linear-gradient(135deg,#f59e0b,#b45309);
  color:#fff;
}
.medium-btn:hover { box-shadow: 0 0 22px #fbbf24; transform: translateY(-5px) scale(1.06); }

/* Bot√µes do timer - VERDE - class timer-btn */
.timer-btn { background: linear-gradient(135deg,#16a34a,#065f46); color:#fff; }
.timer-btn:hover { box-shadow: 0 0 14px #34d399; transform: translateY(-3px) scale(1.03); }

/* Bot√µes r√°pidos do timer (30s,40s,50s) - estilo mais compacto */
.timer-quick { padding:6px 10px; font-size:0.95rem; border-radius:8px; }

/* Bot√µes de participantes - rosa / remover vermelho */
.participant-btn1 { background: linear-gradient(135deg,#d13131,#bf080e); color:#000000; }
.participant-btn { background: linear-gradient(135deg,#48ec92,#18be4f); color:#000000; }
.participant-btn:hover { box-shadow: 0 0 14px #65dc93; }
.remove-btn { background: linear-gradient(135deg,#e70d0d,#d3151e); color:#0a0a0a; }
.remove-btn:hover{ box-shadow: 0 0 14px #5f0f0f; }

/* pequenos ajustes de espa√ßamento para bot√µes dentro dos cards */
.top-controls { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
.controls { display:flex; justify-content:center; margin-bottom:10px; }
.card button { margin:4px 6px; }

/* ===== FILTRO DE CAP√çTULOS ===== */
.chapter-filter .checkboxes {
  display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:10px; padding:10px; background: rgba(0,0,0,0.08); border-radius:10px; transition: all 0.3s ease;
}
.chapter-filter label { background: rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; cursor:pointer; transition: background 0.2s, transform 0.2s; }
.chapter-filter input[type="checkbox"] { margin-right:6px; }
.chapter-filter label:hover { transform: scale(1.03); }

/* responsividade simples */
@media (max-width:900px){ .container{flex-direction:column; align-items:stretch;} }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header>
  <h1>üìñ Sorteador de Quest√µes </h1>
  <div class="header-right">
    <!-- indicador de modo atual -->
    <div id="mode-badge" class="mode-badge">Modo: Normal</div>

    <!-- bot√£o de tema -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema">üåô</button>

    <!-- bot√£o hamb√∫rguer -->
    <div style="position:relative;">
      <button class="hamburger" onclick="toggleMenu()" aria-label="Abrir menu">‚ò∞</button>
      <div id="top-menu" class="menu" role="menu" aria-hidden="true">
        <button onclick="setModeNoAnswer()">Sorteador sem resposta</button>
        <button onclick="openUserQuestionsPanel()">Inserir novas quest√µes</button>
        <button onclick="downloadPdf()">Download quest√µes (PDF)</button>
      </div>
    </div>
  </div>
</header>

<!-- ===== CONTAINER PRINCIPAL ===== -->
<div class="container">

  <!-- ===== CARD DE SORTEIO ===== -->
  <div class="card">
    <h2>Sorteio das quest√µes</h2>

    <!-- Filtro de cap√≠tulos + Reset lado a lado -->
    <div class="top-controls">
      <!-- small-btn: estilo azul definido no CSS -->
      <button class="small-btn" onclick="toggleFilterPanel()">üìÇ Filtro de cap√≠tulos</button>
      <button class="small-btn" onclick="resetQuestions()">üîÑ Resetar Quest√µes</button>
    </div>

    <!-- Bot√£o sortear abaixo, destacado (medium-btn laranja/dourado) -->
    <div class="controls">
      <button class="medium-btn" onclick="drawQuestion()">üé≤ Sortear Quest√£o</button>
    </div>

    <!-- Painel de checkboxes oculto (gerado via JS) -->
    <div class="chapter-filter">
      <div class="checkboxes" id="chapter-filter-container" style="display:none;">
        <!-- Checkboxes ser√£o gerados via JS em generateChapterCheckboxes() -->
      </div>
    </div>

    <!-- Caixa da quest√£o -->
    <div id="question-box">Clique em sortear para come√ßar!</div>

    <!-- bot√£o revelar resposta (aparece apenas no modo sem resposta quando houver pergunta) -->
    <div style="text-align:center; margin-top:8px;">
      <button id="reveal-btn" class="small-btn" style="display:none;" onclick="revealAnswer()">üîì Revelar resposta</button>
    </div>

  </div>

  <!-- ===== CARD DE TIMER ===== -->
  <div class="card">
    <h2>Temporizador</h2>
    <div id="timer-display">00:00</div>

    <!-- Input para definir tempo manualmente -->
    <label for="custom-time">Definir tempo (segundos): </label>
    <input type="number" id="custom-time" min="1" placeholder="Ex: 50" style="width: 100px;">
    <button class="timer-btn" onclick="setCustomTimer()">‚è±Ô∏è Definir</button>

    <!-- Bot√µes r√°pidos 30/40/50 (timer-quick + timer-btn) -->
    <div style="margin:10px 0; text-align:center;">
      <button class="timer-btn timer-quick" onclick="setQuickTime(30)">30s</button>
      <button class="timer-btn timer-quick" onclick="setQuickTime(40)">40s</button>
      <button class="timer-btn timer-quick" onclick="setQuickTime(50)">50s</button>
    </div>

    <!-- Controles principais do timer -->
    <div style="text-align:center;">
      <button class="timer-btn" onclick="startTimer()">‚ñ∂Ô∏è Iniciar</button>
      <button class="timer-btn" onclick="pauseTimer()">‚è∏Ô∏è Pausar</button>
      <button class="timer-btn" onclick="resetTimer()">‚èπÔ∏è Resetar</button>
    </div>

    <!-- op√ß√µes do bipe -->
    <div style="margin-top:10px; text-align:center;">
      <label style="margin-right:8px;"><input type="checkbox" id="beep-enabled" checked> Bipe nos √∫ltimos</label>
      <input type="number" id="beep-start" value="5" min="1" style="width:60px;"> s
      <div style="font-size:0.85rem; color:rgba(255,255,255,0.7); margin-top:6px;">(bipe configur√°vel para os √∫ltimos segundos)</div>
    </div>

    <!-- som do alarme (j√° inclusos) -->
    <audio id="alarm-sound">
      <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    </audio>
  </div>

  <!-- ===== HIST√ìRICO DE QUEST√ïES ===== -->
  <div class="card">
    <h2>Quest√µes sorteadas</h2>
    <ul id="history-list"></ul>
  </div>

  <!-- ===== PARTICIPANTES ===== -->
  <div class="card">
    <h2>Participantes</h2>
    <!-- input simples + bot√£o adicionar (participant-btn rosa) -->
    <input type="text" id="participant-name" placeholder="Nome do participante">
    <button class="participant-btn" onclick="addParticipant()">‚ûï Adicionar</button>
    <ul id="participants-list"></ul>
  </div>

</div>

<!-- rodap√© -->
<footer style="margin:18px 0 36px 0; color:rgba(0,0,0,0.55); font-size:0.95rem;">
  2025 v1.4 
</footer>

<!-- ===== MODAL QUEST√ïES DO USU√ÅRIO ===== -->
<div id="user-questions-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:100; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#222; border-radius:14px; padding:28px; max-width:520px; width:92%; box-shadow:0 8px 32px rgba(0,0,0,0.22); position:relative;">
      <h2 style="margin-top:0;">Inserir novas quest√µes</h2>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <label style="white-space:nowrap;">Cap√≠tulo: <input type="text" id="user-chapter" style="width:80px; margin-left:6px;"></label>
        <div style="font-size:0.85rem; color:#555;">(aplicado a todas as linhas abaixo)</div>
      </div>
      <div>
        <label style="display:block; margin-bottom:6px;">Pergunta + resposta (uma por linha):</label>
        <textarea id="user-question" rows="6" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;" placeholder="Ex: Quem fez X? ‚ÄúResposta‚Äù"></textarea>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="small-btn" onclick="addUserQuestion()">Adicionar</button>
        <button class="small-btn" onclick="setUserQuestionsMode()">Usar apenas quest√µes inseridas</button>
        <button class="remove-btn" onclick="closeUserQuestionsPanel()">Fechar</button>
      </div>
      <button class="remove-btn" onclick="clearAllUserQuestions()" style="position:absolute; top:8px; right:8px; font-size:0.85rem;">Limpar tudo</button>
      <div style="margin-top:12px;">
        <strong>Quest√µes inseridas:</strong>
        <ul id="user-questions-list" style="max-height:160px; overflow-y:auto; font-size:0.95rem; padding-left:18px;"></ul>
      </div>
    </div>
  </div>

<script>
/* C√≥digo revisado: corrige ordem de inicializa√ß√£o, persiste participantes, filtro,
   hist√≥rico e estado do sorteio; reset limpa tudo. */

/* ====== DADOS / ESTADO ====== */
const allQuestions = [
  {chapter:"1", question:"1- De onde o Senhor chamou e falou com mois√©s? ‚Äúda tenda da congrega√ß√£o‚Äù 1.1"},
  {chapter:"1", question:"2- O Senhor mandou mois√©s falar a quem sobre, quando algum de v√≥s oferecer as ofertas, oferecereis de gado, vacas e ovelhas? ‚Äúfalai aos filhos de Israel‚Äù 1.2"},
  {chapter:"1", question:"3- Quais as condi√ß√µes que o Senhor estabeleceu para a oferta de holocausto de gado? ‚Äúsem mancha‚Äù 1.3"},
  {chapter:"1", question:"4- Onde se deveria oferecer o gado macho? ‚Äú√† porta da tenda da congrega√ß√£o oferecer√°‚Äù 1.3"},
  {chapter:"1", question:"5- Onde o Senhor mandou colocar a m√£o para que o holocausto seja aceito por ele? ‚ÄúE por√° sua m√£o sobre a cabe√ßa do holocausto‚Äù 1.4"},
  {chapter:"1", question:"6- Para o que o Senhor mandou colocar a m√£o sobre a cabe√ßa do holocausto? ‚Äúpara que seja aceito por ele, para expia√ß√£o‚Äù 1.4"},
  {chapter:"1", question:"7- Perante quem deveriam degolar o bezerro? ‚Äúperante o Senhor, e os filhos de Ar√£o‚Äù 1.5"},
  {chapter:"1", question:"8- Quem oferecer√° o sangue e espargir√° o sangue √† roda sobre o altar? ‚Äúos sacerdotes‚Äù 1.5"},
  {chapter:"1", question:"9- Onde fica a roda sobre o altar, onde o sangue do bezerro deve ser oferecido pelos sacerdotes? ‚Äúest√° diante da porta da tenda da congrega√ß√£o‚Äù 1.5"},
  {chapter:"1", question:"10- Al√©m de esfolar o holocausto o que mais deveria ser feito? ‚Äúe o partir√° nos seus peda√ßos‚Äù 1.6"},
  {chapter:"1", question:"11- E os filhos de Ar√£o, os sacerdotes, dever√£o colocar fogo sobre o altar pondo em ordem o que? ‚Äúpondo em ordem a lenha sobre o fogo‚Äù 1.7"},
  {chapter:"1", question:"12- Tamb√©m os filhos de Ar√£o, os sacerdotes, por√£o em ordem o que? ‚Äúpor√£o em ordem os peda√ßos‚Äù 1.8"},
  {chapter:"1", question:"13- Sobre onde a cabe√ßa e o redenho do gado deveriam ser colocados? ‚Äúsobre a lenha que est√° no fogo em cima do altar‚Äù 1.8"},
  {chapter:"1", question:"14- Holocausto √©? ‚Äúoferta queimada‚Äù 1.9"},
  {chapter:"1", question:"15- O que deve ser feito com a fressura (entranhas) do gado oferecido? ‚Äúlavar-se-√£o com √°gua‚Äù 1.9"},
  {chapter:"1", question:"16- E se a oferta for gado mi√∫do, de ovelhas ou de cabras, oferecer√° o que? ‚Äúoferecer√° macho sem mancha‚Äù 1.10"},
  {chapter:"1", question:"17- A oferta de gado deve ser degolada ao lado do altar, para qual banda? ‚Äúpara a banda do norte‚Äù 1.11"},
  {chapter:"1", question:"18- Depois de partir os peda√ßos como tamb√©m a cabe√ßa e o seu redenho, onde os sacerdotes os por√£o? ‚Äúos por√° em ordem sobre a lenha‚Äù 1.12"},
  {chapter:"1", question:"19- Se a oferta for de aves o que deve ser oferecido? ‚Äúoferecer√° oferta de rolas ou de pombinhos‚Äù 1.14"},
  {chapter:"1", question:"20- O que o sacerdote deve fazer com o holocausto de aves ao oferecer sobre o altar? ‚Äúe lhe torcer√° o pesco√ßo com sua unha e a queimar√° sobre o altar‚Äù 1.15"},
  {chapter:"1", question:"21- Onde o sangue da oferta das aves ser√° espremido? ‚Äúo seu sangue ser√° espremido na parede do altar‚Äù 1.15"},
  {chapter:"1", question:"22- Quanto ao holocausto de aves, o papo e as penas ser√£o tiradas e ser√£o lan√ßadas onde? ‚Äúlan√ßar√° junto ao altar, para banda do oriente, no lugar da cinza‚Äù 1.16"},
  {chapter:"1", question:"23- Ao fender a ave com suas asas, o que n√£o deveria acontecer? ‚Äúpor√©m n√£o a partir√°‚Äù 1.17"},
  {chapter:"2", question:"24- Quanto √† oferta de manjares, o que deve ser oferecido? ‚Äúa sua oferta ser√° de flor de farinha‚Äù 2.1"},
  {chapter:"2", question:"25- O que deve ser colocado sobre a oferta de manjares? ‚Äúe por√° um incenso sobre ela‚Äù 2.1"},
  {chapter:"2", question:"26- A quem deve ser trazido o holocausto de aves e quem tomar√° dela um punhado da flor de farinha? ‚Äúe trar√° aos filhos de Ar√£o, os sacerdotes‚Äù 2.2"},
  {chapter:"2", question:"27- Qual parte da oferta de manjares ser√° de Ar√£o e de seus filhos? ‚Äúe o que sobrejar/sobrar‚Äù (resposta em 2.3 e 2.10)"},
  {chapter:"2", question:"28- Quando a oferta for de manjares cozidos no forno, o que ser√°? ‚Äúser√° de bolos asmos, flor de farinha, amassados com azeite, e coscor√µes asmos untados com azeite‚Äù 2.5"},
  {chapter:"2", question:"29- Como deve ser a oferta de manjares cozida na ca√ßarola? ‚Äúser√° de flor de farinha sem fermento, amassada com azeite‚Äù 2.5"},
  {chapter:"2", question:"30- Como ser√° a oferta de manjares da sert√£? ‚Äúfar-se-√° da flor de farinha com azeite‚Äù 2.7"},
  {chapter:"2", question:"31- Qual oferta de manjares n√£o deve ser oferecida ao Senhor? ‚ÄúNenhuma oferta com fermento, nenhum mel‚Äù 2.11"},
  {chapter:"2", question:"32- Deles, oferecereis ao Senhor por oferta das prim√≠cias, por√©m n√£o subir√£o aonde? ‚Äúpor√©m sobre o altar n√£o subir√£o por cheiro suave‚Äù 2.12"},
  {chapter:"2", question:"33- O que n√£o poder√°s deixar faltar na oferta de manjares? ‚Äúe n√£o deixar√° faltar √† tua oferta de manjares o sal do concerto de Deus, em toda sua oferta oferecer√°s sal‚Äù 2.13"},
  {chapter:"2", question:"34- Como deve ser a oferta de manjares das tuas prim√≠cias? ‚Äúoferecer√°s a oferta de manjares das prim√≠cias de espigas verdes, tostadas ao fogo, isto √©, do gr√£o trilhado de espigas verdes cheias‚Äù 2.14"},
  {chapter:"2", question:"35- Sobre a oferta de manjares das prim√≠cias, onde se colocar√° incenso? ‚Äúe por√° sobre ela incenso‚Äù 2.15"},
  {chapter:"3", question:"36- Quanto √† oferta de sacrif√≠cio pac√≠fico (da paz, das gra√ßas), como o gado deveria ser? ‚Äúmacho ou f√™mea sem mancha‚Äù 3.1"},
  {chapter:"3", question:"37- Quanto ao sacrif√≠cio pac√≠fico, onde o gado dever√° ser degolado? ‚Äúdegolar√° diante da porta da tenda da congrega√ß√£o‚Äù 3.2"},
  {chapter:"3", question:"38- Quais partes do gado os filhos de Ar√£o queimar√£o sobre o altar no sacrif√≠cio pac√≠fico? ‚Äúgordura sobre a fressura, ambos os rins e a gordura que est√° sobre eles e sobre as tripas‚Äù 3.3-5"},
  {chapter:"3", question:"39- Quanto ao sacrif√≠cio de paz, como deve ser o gado mi√∫do? ‚Äúmacho ou f√™mea, sem mancha‚Äù 3.6"},
  {chapter:"3", question:"40- Se o sacrif√≠cio for o cordeiro, onde os filhos de Ar√£o espargir√£o seu sangue? ‚ÄúSobre o altar em redor‚Äù 3.7-8"},
  {chapter:"3", question:"41- Do sacrif√≠cio pac√≠fico, quais partes do cordeiro ser√£o oferecidas por oferta queimada? ‚Äúa sua gordura, a cauda toda ‚Ä¶ a gordura que cobre a fressura‚Äù 3.9-11"},
  {chapter:"3", question:"42- Quanto √† oferta pac√≠fica de cabra, como deve ser oferecida? ‚Äúe por√° sua m√£o sobre a cabe√ßa e a degolar√° diante da tenda da congrega√ß√£o‚Äù 3.12-16"},
  {chapter:"3", question:"43- Qual estatuto perp√©tuo ser√° nas vossas gera√ß√µes? ‚Äúnenhuma gordura nem sangue comereis‚Äù 3.17"},
  {chapter:"4", question:"44- Se o sacerdote ungido pecar para esc√¢ndalo, o que deve ser oferecido? ‚Äúoferecer√° pelo seu pecado ‚Ä¶ um novilho sem mancha‚Äù 4.3"},
  {chapter:"4", question:"45- O sacerdote ungido levar√° o novilho √† tenda da congrega√ß√£o, e o sacerdote molhar√° o que no sangue? ‚Äúe o sacerdote molhar√° seus dedos no sangue‚Äù 4.5"},
  {chapter:"4", question:"46- Ao molhar seu dedo no sangue do novilho, por quantas vezes o sangue ser√° espargido perante o Senhor? ‚Äúsete vezes‚Äù 4.6"},
  {chapter:"4", question:"47- Quanto ao sacrif√≠cio para o sacerdote, tamb√©m por√° o sacerdote daquele sangue onde? ‚Äúsobre as pontas do altar do incenso arom√°tico‚Äù 4.7"},
  {chapter:"4", question:"48- O que deve ser feito com o resto do sangue do novilho? ‚Äúderramar√° √† base do altar do holocausto‚Äù 4.7"},
  {chapter:"4", question:"49- O que deve ser tirado todo do novilho da expia√ß√£o? ‚ÄúE toda a gordura‚Ä¶ gordura que cobre a fressura e toda gordura que est√° sobre a fressura‚Äù 4.8"},
  {chapter:"4", question:"50- Quanto ao sacrif√≠cio pac√≠fico, o que o sacerdote far√° com a parte do animal que lhe cabe? ‚Äúo sacerdote queimar√° sobre o altar do holocausto‚Äù 4.10"},
  {chapter:"4", question:"51- Quanto ao sacrif√≠cio do sacerdote, o couro do novilho e toda a sua carne, o que deve ser feito? ‚Äútodo aquele novilho levar√° fora do arraial, a um lugar limpo, e o queimar√° com fogo‚Äù 4.12"},
  {chapter:"4", question:"52- O que deve ser feito se a congrega√ß√£o pecar e o pecado for not√≥rio? ‚Äúent√£o a congrega√ß√£o oferecer√° um novilho, por expia√ß√£o do pecado‚Äù 4.14"},
  {chapter:"4", question:"53- No sacrif√≠cio pelo povo, o sacerdote molhar√° o dedo sangue e o espargir√° quantas vezes? ‚Äúsete vezes‚Äù 4.17"},
  {chapter:"4", question:"54- E far√° a este novilho como fez ao novilho da expia√ß√£o; o sacerdote far√° o que? ‚Äúe o sacerdote far√° por eles a propicia√ß√£o‚Äù 4.20"},
  {chapter:"4", question:"55- Ap√≥s feita a propicia√ß√£o, o que acontecer√° no sacrif√≠cio pelos erros do povo? ‚Äúe lhes ser√° perdoado os pecados‚Äù 4.20"},
  {chapter:"4", question:"56- Qual animal deve ser ofertado quando um pr√≠ncipe pecar? ‚Äúent√£o trar√° por sua oferta um bode‚Äù 4.23"},
  {chapter:"4", question:"57- O que deve ser queimado na oferta do pr√≠ncipe? ‚Äútamb√©m queimar√° sobre o altar toda a sua gordura‚Äù 4.26"},
  {chapter:"4", question:"58- Qual animal pode ser levado como oferta na expia√ß√£o de qualquer pessoa? ‚Äúent√£o trar√° por sua oferta uma cabra f√™mea sem mancha‚Äù 4.28"},
  {chapter:"4", question:"59- O que deve ser feito com o resto do sangue da oferta de qualquer pessoa? ‚Äúe todo o resto do seu sangue derramar√° √† base do altar‚Äù 4.30"},
  {chapter:"4", question:"60- Na oferta de qualquer pessoa qual outro animal poderia ser trazido al√©m da cabra? ‚ÄúMas, se pela sua oferta trouxer uma cabra para expia√ß√£o, sem mancha a trar√°‚Äù 4.32"},
  {chapter:"5", question:"61- O que acontecer√° com a pessoa que ouvir uma voz de blasf√™mia e n√£o denunciar? ‚Äúent√£o levar√° a sua iniquidade‚Äù 5.1"},
  {chapter:"5", question:"62- Quando alguma pessoa tocar em alguma coisa imunda, seja corpo de animal imundo ‚Ä¶ contudo ele ser√° o que? ‚Äúcontudo ser√° ele imundo e culpado‚Äù 5.2"},
  {chapter:"5", question:"63- Quando tocar a imund√≠cie de um homem, seja qual for a sua imund√≠cia com que se fa√ßa imundo o que acontecer√°? ‚Äúe o souber depois ser√° culpado‚Äù 5.3"},
  {chapter:"5", question:"64- O que acontecer√° com o homem que pronuncia temerariamente juramento, e lhe for oculto? ‚Äúculpado ser√° numa dessas coisas‚Äù 5.4"},
  {chapter:"5", question:"65- Sendo culpado numa destas coisas, o que deve ser feito? ‚Äúconfessar√° aquilo em que pecou‚Äù 5.5"},
  {chapter:"5", question:"66- Quanto ao sacrif√≠cio pelos pecados ocultos, quais animais devem ser oferecidos? ‚Äúuma f√™mea de gado mi√∫do, uma cordeira ou uma cabrinha pelo pecado‚Äù 5.6"},
  {chapter:"5", question:"67- Se a m√£o n√£o alcan√ßar o que basta para o gado mi√∫do, ent√£o o que deve ser levado para expia√ß√£o? ‚Äúent√£o trar√° em expia√ß√£o da culpa que cometeu‚Ä¶ duas rolas ou duas pombinhos‚Äù 5.7"},
  {chapter:"5", question:"68- Se a oferta de pombas e rolas n√£o alcan√ßar, o que deve ser ofertado? ‚ÄúPor√©m, se pela sua oferta n√£o alcan√ßar duas rolas ou dois pombinhos ‚Ä¶ oferta √† d√©cima parte de uma efa de flor de farinha‚Äù 5.11"},
  {chapter:"5", question:"69- O que deve ser feito se uma pessoa cometer transgress√£o e pecar por ignor√¢ncia nas coisas sagradas do Senhor? ‚Äúent√£o trar√° ao Senhor por expia√ß√£o um carneiro sem mancha, conforme a sua estima√ß√£o em siclos de prata‚Äù 5.15"},
  {chapter:"5", question:"70- A quem pecar por ignor√¢ncia nas coisas sagradas, ao restituir o que tirou dever√° acrescentar quanto a mais? ‚Äúe ainda mais acrescentar√° um quinto‚Äù 5.16"},
  {chapter:"5", question:"72- Se alguma pessoa pecar e obrar contra algum de todos os mandamentos do Senhor, o que ser√° imputado? ‚Äúcontudo ser√° ele culpado, e levar√° a sua iniquidade‚Äù 5.17"},
  {chapter:"6", question:"73- O Senhor falou a Mois√©s, para dar ordem a Ar√£o e seus filhos sobre a lei do holocausto, o que √© esta lei? ‚Äúo holocausto ser√° queimado sobre o altar toda a noite at√© pela manh√£, e o fogo do altar arder√° nele‚Äù 6.9"},
  {chapter:"6", question:"74- O sacerdote vestir√° roupas de linho, e vestir√° cal√ßas de linho sobre a sua carne ‚Ä¶ o que ele levantar√° quando o fogo tiver consumido o holocausto? ‚Äúe levantar√° a cinza‚Äù 6.10"},
  {chapter:"6", question:"75- O sacerdote despir√° as suas vestes e vestir√° outras vestes, levar√° as cinzas para onde? ‚Äúe levar√° a cinza fora do arraial para um lugar limpo‚Äù 6.11"},
  {chapter:"6", question:"76- Quando o sacerdote deveria acender a lenha para manter o fogo no altar aceso? ‚Äúmas o sacerdote acender√° lenha nele cada manh√£‚Äù 6.12"}
];
//
// elementos
const historyList = document.getElementById("history-list");
const questionBox = document.getElementById("question-box");
const modeBadge = document.getElementById('mode-badge');

// chaves localStorage
const LS_KEYS = {
  HIDE: 'maratona_hideAnswers',
  FILTER: 'maratona_filteredChapters',
  INITIAL_TIME: 'maratona_initialTime',
  BEEP_ENABLED: 'maratona_beepEnabled',
  BEEP_START: 'maratona_beepStart',
  PARTICIPANTS: 'maratona_participants',
  HISTORY: 'maratona_history_indices',
  USER_QUESTIONS: 'maratona_userQuestions',
  USER_MODE: 'maratona_userQuestionsMode'
};

let userQuestions = [];

let hideAnswers = false;
let filteredChapters = [];
let participants = [];
let initialTime = 0;
let timeLeft = 0;
let isRunning = false;
let timer = null;
let lastQuestionObj = null;
let historyIndices = []; // armazena √≠ndices de allQuestions j√° sorteadas
let remainingQuestions = [...allQuestions];

/* ====== HELPERS ====== */
function saveState(){
  try{
    localStorage.setItem(LS_KEYS.HIDE, hideAnswers ? '1' : '0');
    localStorage.setItem(LS_KEYS.FILTER, JSON.stringify(filteredChapters || []));
    localStorage.setItem(LS_KEYS.INITIAL_TIME, String(initialTime || 0));
    const beepEnabledInput = document.getElementById('beep-enabled');
    const beepStartInput = document.getElementById('beep-start');
    localStorage.setItem(LS_KEYS.BEEP_ENABLED, beepEnabledInput ? (beepEnabledInput.checked ? '1' : '0') : '1');
    localStorage.setItem(LS_KEYS.BEEP_START, beepStartInput ? String(beepStartInput.value) : '5');
    localStorage.setItem(LS_KEYS.PARTICIPANTS, JSON.stringify(participants || []));
    localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(historyIndices || []));
    localStorage.setItem(LS_KEYS.USER_QUESTIONS, JSON.stringify(userQuestions || []));
    localStorage.setItem(LS_KEYS.USER_MODE, userQuestionsMode ? '1' : '0');
  }catch(e){ console.error('saveState:', e); }
}

function loadState(){
  try{
    const sHide = localStorage.getItem(LS_KEYS.HIDE);
    hideAnswers = sHide === '1';

    const sFiltered = localStorage.getItem(LS_KEYS.FILTER);
    if(sFiltered) filteredChapters = JSON.parse(sFiltered) || [];

    const sInitial = localStorage.getItem(LS_KEYS.INITIAL_TIME);
    if(sInitial) { initialTime = parseInt(sInitial) || 0; timeLeft = initialTime; }

    const beepEn = localStorage.getItem(LS_KEYS.BEEP_ENABLED);
    const beepSt = localStorage.getItem(LS_KEYS.BEEP_START);

    const savedParticipants = localStorage.getItem(LS_KEYS.PARTICIPANTS);
    if(savedParticipants) participants = JSON.parse(savedParticipants) || [];

    const savedHistory = localStorage.getItem(LS_KEYS.HISTORY);
    if(savedHistory) historyIndices = JSON.parse(savedHistory) || [];

    const savedUserQuestions = localStorage.getItem(LS_KEYS.USER_QUESTIONS);
    if(savedUserQuestions) userQuestions = JSON.parse(savedUserQuestions) || [];
    userQuestionsMode = localStorage.getItem(LS_KEYS.USER_MODE) === '1';

    // restaurar timer inputs
    const beepEnabledInput = document.getElementById('beep-enabled');
    const beepStartInput = document.getElementById('beep-start');
    if(beepEnabledInput && typeof beepEn !== 'undefined' && beepEn !== null) beepEnabledInput.checked = beepEn === '1';
    if(beepStartInput && beepSt) beepStartInput.value = beepSt;

    // aplicar modo
    if(userQuestionsMode){
      modeBadge.innerText = 'Modo: Quest√µes do usu√°rio';
      remainingQuestions = userQuestions.map((q,i)=> ({...q,_idx:i}));
    }else{
      modeBadge.innerText = hideAnswers ? 'Modo: Sem resposta' : 'Modo: Normal';
      if(filteredChapters && filteredChapters.length > 0){
        remainingQuestions = allQuestions
          .map((q,i)=> ({...q,_idx:i}))
          .filter(q => filteredChapters.includes(q.chapter))
          .map(q => ({chapter:q.chapter, question:q.question, _idx:q._idx}));
      } else {
        remainingQuestions = allQuestions.map((q,i)=> ({...q,_idx:i}));
      }
    }

    // remover itens j√° sorteados (historyIndices)
    if(historyIndices.length > 0){
      remainingQuestions = remainingQuestions.filter(q => !historyIndices.includes(q._idx));
      historyList.innerHTML = '';
      historyIndices.forEach(idx => {
        const q = userQuestionsMode ? userQuestions[idx] : allQuestions[idx];
        if(q){
          const li = document.createElement('li');
          li.innerText = hideAnswers ? stripAnswer(q.question) : q.question;
          historyList.appendChild(li);
        }
      });
      historyList.scrollTop = historyList.scrollHeight;
    }
    renderParticipants();
    renderUserQuestionsList();
  }catch(e){ console.error('loadState:', e); }
}

/* ===== MENU / MODO / B√çBLIA ===== */
function toggleMenu(){
  const m = document.getElementById('top-menu');
  const shown = m.style.display === 'block';
  m.style.display = shown ? 'none' : 'block';
  m.setAttribute('aria-hidden', shown ? 'true' : 'false');
}

function setModeNoAnswer(){
  hideAnswers = !hideAnswers;
  modeBadge.innerText = hideAnswers ? 'Modo: Sem resposta' : 'Modo: Normal';
  toggleMenu();
  questionBox.innerText = hideAnswers ? "Modo sem resposta ativado. Ao sortear, as perguntas aparecer√£o sem a resposta." : "Modo normal ativado.";
  questionBox.classList.add('show');
  const revealBtn = document.getElementById('reveal-btn');
  revealBtn.style.display = (hideAnswers && lastQuestionObj) ? 'inline-block' : 'none';
  saveState();
}

function openBible(){
  try{ toggleMenu(); }catch(e){}
  window.open('https://www.bibliaon.com/','_blank','noopener');
  hideAnswers = false;
  modeBadge.innerText = 'Modo: B√≠blia';
  saveState();
}

function openUserQuestionsPanel(){
  document.getElementById('user-questions-modal').style.display = 'flex';
  renderUserQuestionsList();
  toggleMenu();
}
function closeUserQuestionsPanel(){
  document.getElementById('user-questions-modal').style.display = 'none';
}
function addUserQuestion(){
  const chapter = document.getElementById('user-chapter').value.trim();
  const question = document.getElementById('user-question').value.trim();
  if(!chapter || !question) return alert('Preencha cap√≠tulo e pergunta!');
  userQuestions.push({chapter, question});
  document.getElementById('user-chapter').value = '';
  document.getElementById('user-question').value = '';
  renderUserQuestionsList();
  saveState();
}
function renderUserQuestionsList(){
  const ul = document.getElementById('user-questions-list');
  if(!ul) return;
  ul.innerHTML = '';
  if(userQuestions.length === 0){
    ul.innerHTML = '<li style="opacity:0.6;">Nenhuma quest√£o inserida.</li>';
    return;
  }
  userQuestions.forEach((q,i)=>{
    const li = document.createElement('li');
    li.textContent = `Cap√≠tulo ${q.chapter}: ${q.question}`;
    li.innerHTML += ` <button class="remove-btn" style="font-size:0.8em;" onclick="removeUserQuestion(${i})">‚ùå</button>`;
    ul.appendChild(li);
  });
}
function removeUserQuestion(idx){
  userQuestions.splice(idx,1);
  renderUserQuestionsList();
  saveState();
}
function setUserQuestionsMode(){
  if(userQuestions.length === 0) return alert('Insira pelo menos uma quest√£o!');
  userQuestionsMode = true;
  modeBadge.innerText = 'Modo: Quest√µes do usu√°rio';
  closeUserQuestionsPanel();
  questionBox.innerText = "Modo ativado: apenas quest√µes inseridas ser√£o sorteadas.";
  questionBox.classList.add('show');
  // reset hist√≥rico para modo usu√°rio
  historyIndices = [];
  remainingQuestions = userQuestions.map((q,i)=> ({...q,_idx:i}));
  saveState();
  historyList.innerHTML = '';
  document.getElementById('reveal-btn').style.display = (hideAnswers && lastQuestionObj) ? 'inline-block' : 'none';
}

/* remove menu se clicar fora */
document.addEventListener('click', (e)=>{
  const menu = document.getElementById('top-menu');
  const hamb = document.querySelector('.hamburger');
  if(!menu) return;
  if(menu.style.display === 'block' && !menu.contains(e.target) && !hamb.contains(e.target)){
    menu.style.display = 'none';
    menu.setAttribute('aria-hidden','true');
  }
});

/* remove resposta de uma pergunta (texto antes da primeira aspa) */
function stripAnswer(text){
  if(!text) return text;
  const quoteChars = ['‚Äú','"','¬´','‚Äπ','‚Äû','‚Äö','\''];
  let indices = quoteChars.map(q=> text.indexOf(q)).filter(i=>i>=0);
  if(indices.length === 0) return text;
  const minIdx = Math.min(...indices);
  return text.slice(0, minIdx).trim();
}

/* ===== FILTRO DE CAP√çTULOS ===== */
function generateChapterCheckboxes(){
  const container = document.getElementById("chapter-filter-container");
  container.innerHTML = "";

  const allLabel = document.createElement("label");
  allLabel.innerHTML = `<input type="checkbox" id="chapter-all" value="all"> Todos`;
  container.appendChild(allLabel);

  const chapters = [...new Set(allQuestions.map(q=>q.chapter))].sort((a,b)=>a-b);
  chapters.forEach(ch=>{
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" class="chapter-item" value="${ch}"> Cap√≠tulo ${ch}`;
    container.appendChild(label);
  });

  const applyBtn = document.createElement("button");
  applyBtn.textContent="Aplicar";
  applyBtn.className = 'small-btn';
  applyBtn.onclick=applyFilter;
  container.appendChild(applyBtn);

  // behavior
  setTimeout(()=> {
    const allChk = document.getElementById('chapter-all');
    if(allChk){
      allChk.addEventListener('change', ()=> {
        const items = document.querySelectorAll('#chapter-filter-container .chapter-item');
        items.forEach(i=> i.checked = allChk.checked);
        if(allChk.checked){
          filteredChapters = [];
          // rebuild remainingQuestions from allQuestions minus history
          remainingQuestions = allQuestions.map((q,i)=> ({...q,_idx:i})).filter(q=> !historyIndices.includes(q._idx));
        }
        saveState();
      });
    }

    // if loaded filter exists, apply checkboxes
    if(filteredChapters && filteredChapters.length > 0){
      const items = document.querySelectorAll('#chapter-filter-container .chapter-item');
      items.forEach(i=> i.checked = filteredChapters.includes(i.value));
      const allChk2 = document.getElementById('chapter-all');
      if(allChk2) allChk2.checked = items.length === document.querySelectorAll('#chapter-filter-container input.chapter-item:checked').length;
    }
  },0);
}

function toggleFilterPanel(){
  const panel = document.getElementById("chapter-filter-container");
  panel.style.display = panel.style.display === "flex" ? "none" : "flex";
}

function applyFilter(){
  const allChk = document.getElementById('chapter-all');
  if(allChk && allChk.checked){
    filteredChapters = [];
    remainingQuestions = allQuestions.map((q,i)=> ({...q,_idx:i})).filter(q=> !historyIndices.includes(q._idx));
    toggleFilterPanel();
    questionBox.innerText = "Filtro 'Todos' aplicado: usando todas as quest√µes.";
    questionBox.classList.add("show");
    saveState();
    return;
  }

  const checkboxes = document.querySelectorAll("#chapter-filter-container input.chapter-item");
  filteredChapters = Array.from(checkboxes).filter(ch=>ch.checked).map(ch=>ch.value);
  // build remainingQuestions using filter and excluding history
  if(filteredChapters.length > 0){
    remainingQuestions = allQuestions
      .map((q,i)=> ({...q,_idx:i}))
      .filter(q=> filteredChapters.includes(q.chapter) && !historyIndices.includes(q._idx));
    const allChk2 = document.getElementById('chapter-all');
    if(allChk2) allChk2.checked = false;
  } else {
    remainingQuestions = allQuestions.map((q,i)=> ({...q,_idx:i})).filter(q=> !historyIndices.includes(q._idx));
    const allChk2 = document.getElementById('chapter-all');
    if(allChk2) allChk2.checked = true;
  }

  toggleFilterPanel();
  questionBox.innerText = filteredChapters.length > 0 ? "Filtro aplicado! Clique em sortear." : "Nenhum cap√≠tulo selecionado: usando todas as quest√µes.";
  questionBox.classList.add("show");
  saveState();
}

/* ===== SORTEIO ===== */
function drawQuestion(){
  let sourceQuestions = userQuestionsMode ? userQuestions : allQuestions;
  let sourceRemaining = userQuestionsMode
    ? remainingQuestions
    : remainingQuestions;
  if(sourceRemaining.length === 0){
    questionBox.innerText="‚úÖ Todas as quest√µes foram sorteadas! Clique em 'Resetar Quest√µes' para come√ßar de novo.";
    questionBox.classList.add("show");
    document.getElementById('reveal-btn').style.display = 'none';
    return;
  }
  const randomIndex = Math.floor(Math.random()*sourceRemaining.length);
  const picked = sourceRemaining.splice(randomIndex,1)[0]; // {chapter, question, _idx}
  lastQuestionObj = picked;
  historyIndices.push(picked._idx);

  const displayText = hideAnswers ? stripAnswer(picked.question) : picked.question;
  questionBox.innerText = displayText;
  questionBox.classList.add("show");

  const li = document.createElement("li");
  li.innerText = displayText;
  historyList.appendChild(li);
  historyList.scrollTop = historyList.scrollHeight;

  const revealBtn = document.getElementById('reveal-btn');
  revealBtn.style.display = (hideAnswers && lastQuestionObj) ? 'inline-block' : 'none';

  saveState();
}

function revealAnswer(){
  if(!lastQuestionObj) return;
  questionBox.innerText = lastQuestionObj.question;
  questionBox.classList.add('show');
  document.getElementById('reveal-btn').style.display = 'none';
}

/* ===== RESET ===== */
function resetQuestions(){
  if(!confirm('Resetar tudo? Isso limpar√° hist√≥rico, participantes, filtros e configura√ß√µes.')) return;
  historyIndices = [];
  filteredChapters = [];
  participants = [];
  hideAnswers = false;
  initialTime = 0;
  timeLeft = 0;
  lastQuestionObj = null;
  userQuestionsMode = false;
  remainingQuestions = allQuestions.map((q,i)=> ({...q,_idx:i}));
  historyList.innerHTML = '';
  questionBox.innerText="üîÑ Quest√µes resetadas. Clique em sortear!";
  questionBox.classList.add("show");
  document.getElementById('reveal-btn').style.display = 'none';
  modeBadge.innerText = 'Modo: Normal';
  updateTimerDisplay();
  renderParticipants();
  try{
    Object.values(LS_KEYS).forEach(k=> localStorage.removeItem(k));
  }catch(e){ console.error(e); }
  const allChk = document.getElementById('chapter-all');
  if(allChk) allChk.checked = true;
  const items = document.querySelectorAll('#chapter-filter-container .chapter-item');
  items.forEach(i=> i.checked = false);
  userQuestions = [];
  renderUserQuestionsList();
}

/* ===== TIMER ===== */
const timerDisplay = document.getElementById("timer-display");
const alarm = document.getElementById("alarm-sound");
let audioCtx = null;

function playBeep(duration = 120, freq = 880, type = 'sine'){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = 0.0001;
    o.connect(g); g.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
    o.start(now);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration/1000);
    o.stop(now + duration/1000 + 0.02);
  }catch(e){}
}

function updateTimerDisplay(){
  const minutes = String(Math.floor(timeLeft/60)).padStart(2,"0");
  const seconds = String(timeLeft%60).padStart(2,"0");
  timerDisplay.innerText = `${minutes}:${seconds}`;
}

function setCustomTimer(){
  const input = document.getElementById("custom-time");
  const seconds = parseInt(input.value);
  if(isNaN(seconds) || seconds <= 0){ alert("Digite um valor v√°lido em segundos!"); return; }
  timeLeft = seconds;
  initialTime = seconds;
  updateTimerDisplay();
  saveState();
}

function setQuickTime(seconds){
  timeLeft = seconds;
  initialTime = seconds;
  updateTimerDisplay();
  saveState();
}

function startTimer(){
  if(isRunning) return;
  if(timeLeft <= 0){ if(initialTime > 0) timeLeft = initialTime; else return; }
  isRunning = true;
  timerDisplay.classList.add('running');
  timer = setInterval(()=> {
    timeLeft--;
    updateTimerDisplay();

    const beepEnabled = document.getElementById('beep-enabled') ? document.getElementById('beep-enabled').checked : true;
    const beepStart = document.getElementById('beep-start') ? parseInt(document.getElementById('beep-start').value) || 5 : 5;

    if(beepEnabled && timeLeft > 0 && timeLeft <= beepStart){
      playBeep(110, 880);
    }

    if(timeLeft <= 0){
      clearInterval(timer);
      isRunning = false;
      timerDisplay.classList.remove('running');
      timerDisplay.classList.add('finished');
      try{ alarm.currentTime = 0; alarm.play(); }catch(e){}
      setTimeout(()=> timerDisplay.classList.remove('finished'), 3000);
      timeLeft = initialTime;
      updateTimerDisplay();
    }
  },1000);
}

function pauseTimer(){
  clearInterval(timer);
  isRunning = false;
  timerDisplay.classList.remove('running');
}

function resetTimer(){
  clearInterval(timer);
  isRunning = false;
  timeLeft = initialTime;
  updateTimerDisplay();
  timerDisplay.classList.remove('running');
}

/* ===== TEMA ===== */
function toggleTheme(){
  const body = document.body;
  const btn = document.querySelector('.theme-toggle');
  if(body.classList.contains('dark')){
    body.classList.replace('dark','light');
    btn.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme','light');
  } else {
    body.classList.replace('light','dark');
    btn.textContent = 'üåô';
    localStorage.setItem('theme','dark');
  }
}

/* ===== PARTICIPANTES ===== */
function addParticipant(){
  const input = document.getElementById('participant-name');
  const name = input.value.trim();
  if(!name) return alert('Digite um nome v√°lido!');
  if(participants.some(p=>p.name === name)) return alert('Participante j√° cadastrado!');
  participants.push({name, points:0});
  input.value = '';
  renderParticipants();
  saveState();
}

function renderParticipants(){
  const list = document.getElementById('participants-list');
  list.innerHTML = '';
  if(participants.length === 0){
    const li = document.createElement('li');
    li.style.opacity='0.6';
    li.textContent = 'Nenhum participante.';
    list.appendChild(li);
    return;
  }
  participants.forEach((p,index)=>{
    const li = document.createElement('li');
    li.innerHTML = `
      <span><strong>${p.name}</strong> - Pontos: ${p.points}</span>
      <span>
        <button class="participant-btn1" onclick="addPoints(${index},-5)">-5</button>
        <button class="participant-btn" onclick="addPoints(${index},5)">+5</button>
        <button class="participant-btn" onclick="addPoints(${index},10)">+10</button>
        <button class="remove-btn" onclick="removeParticipant(${index})">‚ùå</button>
      </span>
    `;
    list.appendChild(li);
  });
}

function addPoints(index, amount=5){
  participants[index].points += amount;
  renderParticipants();
  saveState();
}

function removeParticipant(index){
  if(!confirm('Remover participante?')) return;
  participants.splice(index,1);
  renderParticipants();
  saveState();
}

/* ===== DOWNLOAD PDF ===== */
function downloadPdf(){
  const w = window.open('','_blank','noopener');
  const style = `<style>body{font-family: Arial, Helvetica, sans-serif; padding:20px;} h1{font-size:18px;} li{margin:6px 0;}</style>`;
  let html = `<html><head><title>Quest√µes - Lev√≠tico</title>${style}</head><body><h1>Quest√µes - Lev√≠tico</h1><ol>`;
  allQuestions.forEach(q=> html += `<li><strong>Cap√≠tulo ${q.chapter}:</strong> ${q.question.replace(/</g,'&lt;')}</li>`);
  html += `</ol></body></html>`;
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(()=> w.print(), 500);
}

/* ===== INICIALIZA√á√ÉO ===== */
window.addEventListener('load', ()=>{
  // tema
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.classList.add(savedTheme);
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

  // set defaults for remainingQuestions with idx
  remainingQuestions = allQuestions.map((q,i)=> ({...q,_idx:i}));

  // gerar checkboxes e carregar estado
  generateChapterCheckboxes();
  loadState();

  // se houver hist√≥rico, remainingQuestions j√° foi filtrado na loadState
  updateTimerDisplay();
  modeBadge.innerText = hideAnswers ? 'Modo: Sem resposta' : modeBadge.innerText;
});

/* persistir quando inputs do bipe mudarem */
document.addEventListener('DOMContentLoaded', ()=>{
  const beepEnabledInput = document.getElementById('beep-enabled');
  const beepStartInput = document.getElementById('beep-start');
  if(beepEnabledInput) beepEnabledInput.addEventListener('change', saveState);
  if(beepStartInput) beepStartInput.addEventListener('change', saveState);
});
</script>

</body>
</html>